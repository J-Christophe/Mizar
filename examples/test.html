<!doctype html>
<html>

<head>
    <title>Getting started with navigation</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <link rel="stylesheet" href="css/test.css">

    <!-- mode dev -->
    <script type="text/javascript" src="test.js"></script>
    <script type="text/javascript" data-main="../src/rconfig.js" src="../node_modules/requirejs/require.js"></script>

    <!-- mode prod -->
    <!--<script type="text/javascript" src="../Mizar.min.js"></script>-->

    <script type="text/javascript">

        var seaLevel = [ "0.0m","0.5m","1.0m","1.5m","2.0m","2.5m","3.0m"];
        var currentSeaLevel = 3;

        function updateSeaLevel() {
            document.getElementById("sl").value=seaLevel[currentSeaLevel];
            if (typeof this.palavasLayer !== "undefined") {
                this.palavasLayer.setParameter("styles",seaLevel[currentSeaLevel]);
                this.palavasLayer.options.styles = seaLevel[currentSeaLevel];
                this.mizar.reloadLayer(palavasLayer);
            }
        }
        function init() {
            document.getElementById("sl").value=seaLevel[currentSeaLevel];
        }
        
        function previousSeaLevel() {
            if (currentSeaLevel>0) {
                currentSeaLevel --;
                updateSeaLevel();
            }
        }

        function nextSeaLevel() {
            if (currentSeaLevel<(seaLevel.length-1)) {
                currentSeaLevel ++;
                updateSeaLevel();
            }
        }
    
        function loadDEMMontBlanc() {
            mizar.addLayer(demMontBlanc,function (id) {
                    var cbLayer = mizar.getLayerByID(id);
                    if (cbLayer.type === Mizar.LAYER.WCSElevation) {
                        mizar.setBaseElevation(cbLayer.name);
                    }
                    
                });
        }
        function unloadDEMMontBlanc() {
            mizar.setBaseElevation("Elevation");
        }
        function setTime() {
            mizar.setTime("2003-08-21T00:00:00.000Z");
        }

        // mode dev
        require(['Mizar'], function (Mizar) {

            div = "MizarCanvas";
            mizarDiv = (typeof div === "string") ? document.getElementById(div) : div;
            mizarConf.canvas = $(mizarDiv)[0];
            mizarConf.planetContext.coordinateSystem.geoideName = Mizar.CRS.WGS84;


            // Create Mizar
            var mizar =  new Mizar(mizarConf);
            this.mizar = mizar;
            // Layers load
            for (var i = 0; i < context.layers.length; i++) {
                var layer = context.layers[i];

                mizar.addLayer(layer,function (id) {
                    var cbLayer = mizar.getLayerByID(id);
                    if (cbLayer.type === Mizar.LAYER.WCSElevation) {
                        mizar.setBaseElevation(cbLayer.name);
                    }
                    if (cbLayer.name === "Palavas") {
                        this.palavasLayer = cbLayer;
                    }

                    if (cbLayer.isBackground() === true) {
                        mizar.addLayer(osLayer,function (id) {});
                        /*setTimeout(function go() {
                            mizar.activatedContext.navigation.zoomTo(
                                [4.025,43.54],
                                //[116.217,29.15],
                            { "distance" : 100000,
                              "duration" : 2000 });
                        },4000);*/
                    }
                });
            }

            for (var i=0;i<climateData.length;i++) {
                var currentThematicId = climateData[i].thematicId;
                var currentThematic = null;
                for (var j=0;j<thematics.length;j++) {
                    if (thematics[j].id === currentThematicId) {
                        currentThematic = thematics[j];
                    }
                }
                options.name = currentThematic.name;
                options.color = currentThematic.color;

                var climateId = mizar.addLayer(options,function(id) {
                    var climateLayer = mizar.getLayerByID(id);
                    climateLayer.addFeatureCollection(climateData[i]);
                });
            }


            var picking = mizar.getServiceByName(Mizar.SERVICE.PickingManager);
            mizarDiv.addEventListener('click', (e) => {
                var pickPoint = mizar.getActivatedContext().getLonLatFromPixel(e.clientX, e.clientY);
                if (pickPoint !== null) {
                    var selection = picking.computeFilterPickSelection(pickPoint);
                    if (selection.length>0) {
                        // Go on first point
                        var coord = selection[0].feature.geometry.coordinates;
                        mizar.activatedContext.navigation.zoomTo(
                                coord,
                            { "distance" : 500000,
                              "duration" : 2000 });
                        
                    }
                }
            });

            // Test values with [] and step
            mizar.getActivatedContext().publish(Mizar.EVENT_MSG.GLOBAL_TIME_INIT,
             {
                 /*start : [2012,0,1],
                 end : [2017,0,1],
                 stepKind : Mizar.TIME_STEP.MONTH,
                 stepValue : 1
                 */
                enumeratedValues : [ "1989","2000-01-27","2001-09-10","2002-09-29","2003-02-20",
                                     "2013-03-07","2013-03-12","2013-05-01","2013-05-11","2013-06-05",
                                     "2015-07-13","2015-07-28","2015-08-07","2015-08-12","2015-08-17","2015-08-22","2015-08-27","2015-09-11","2015-09-01" ]
             });

        });
    </script>
</head>

<body style="margin: 0; padding: 0;" onload="init();">
    <div style="position:absolute; z-index: 10; width:100%;">
        <input type="button" value="<" onclick="previousSeaLevel()"/>
        <input id="sl" type="text" value=""/>
        <input type="button" value=">" onclick="nextSeaLevel()"/>
        <div id="tracker">
            <div id="posTracker" style="background-color:white;float:left;"></div>
        </div>
        <input type="button" value="load DEM MontBlanc" onclick="loadDEMMontBlanc()"/>
        <input type="button" value="unload DEM MontBlanc" onclick="unloadDEMMontBlanc()"/>
        <input type="button" value="setTime" onclick="setTime()"/>
    </div>
    <div style="position: absolute; right:8px; z-index: 11; width:116px;">
        <div id="compassDiv"></div>
    </div>
    <div style="position: absolute; right:8px; bottom:50px; z-index: 11; width:116px;">
        <div id="timeTravelDiv"></div>
    </div>
    <div style="position: absolute; right:8px; bottom:10px; z-index: 11; width:116px;">
        <div id="textTimeTravelDiv"></div>
    </div>
    <canvas id="MizarCanvas" onclick="click" style="border: none; margin: 0; padding: 0;">
    </canvas>

</body>
</html>