<!doctype html>
<html>

<head>
    <title>Getting started with navigation</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <!-- mode dev -->
    <script type="text/javascript" data-main="../src/rconfig.js" src="../node_modules/requirejs/require.js"></script>

    <!-- mode prod -->
    <!--<script type="text/javascript" src="../Mizar.min.js"></script>-->

    <script type="text/javascript">

        var seaLevel = [ "0.0m","0.5m","1.0m","1.5m","2.0m","2.5m","3.0m"];
        var currentSeaLevel = 3;

        function updateSeaLevel() {
            document.getElementById("sl").value=seaLevel[currentSeaLevel];
            if (typeof this.palavasLayer !== "undefined") {
                this.palavasLayer.setParameter("styles",seaLevel[currentSeaLevel]);
                this.palavasLayer.forceRefresh();
            }
            
        }
        function init() {
            document.getElementById("sl").value=seaLevel[currentSeaLevel];
        }
        function previous() {
            if (currentSeaLevel>0) {
                currentSeaLevel --;
                updateSeaLevel();
            }
        }
        function next() {
            if (currentSeaLevel<(seaLevel.length-1)) {
                currentSeaLevel ++;
                updateSeaLevel();
            }
        }
    

        // mode dev
        require(['Mizar'], function (Mizar) {

            div = "MizarCanvas";
            mizarDiv = (typeof div === "string") ? document.getElementById(div) : div;

            var context = {
                "layers": [
                    {
                        "type": "WCSElevation",
                        "name": "Elevation",
                        "baseUrl": "http://demonstrator.telespazio.com/wcspub",
                        "coverage": "GTOPO",
                        "version": "1.0.0",
                        "minElevation": -32000,
                        "scale": 15
                    },
                    {
                        "name": "Blue Marble",
                        "type": "WMS",
                        "baseUrl": "http://80.158.6.138/mapserv?map=WMS_BLUEMARBLE",
                        "visible": true,
                        "background": true
                    },
                    /*{
                        "name": "Niger",
                        "type": "WMS",
                        "baseUrl": "http://80.158.6.138/mapserv?map=WMS_NIGER",
                        "layers": "NIGER_SCENE",
                        "visible": true,
                        "background": false,
                        "transparent":true,
                        "format":"image/png"
                    },*/
                    {
                        "name": "Palavas",
                        "type": "WMS",
                        "baseUrl": "http://80.158.6.138/mapserv?map=WMS_PALAVAS",
                        "layers": "PALAVAS",
                        "visible": true,
                        "background": false,
                        "transparent":true,
                        "format":"image/png"
                    },
                   {
                        "category": "Other",
                        "type": "Atmosphere",
                        "exposure": 1.4,
                        "wavelength": [ 0.56, 0.66, 0.78 ],
                        "name": "Atmosphere",
                        "lightDir": [ 0, 1, 0 ],
                        "visible": false
                    },
                    {
                        "category": "Other",
                        "type": "TileWireframe",
                        "name": "Coordinates Grid",
                        "outline": true,
                        "visible": true
                    }
                ]};


            // Create Mizar
            var mizar =  new Mizar({
                        canvas: $(mizarDiv)[0],
                        configuration: {
                            "mizarBaseUrl":"localhost/js/MizarWidget/external/Mizar/examples",
                            "debug":false,
                            "isMobile":false,
                            "positionTracker":true,
                            "elevationTracker":false,
                            "registry":false,
                            "proxyUse":false,
                            "proxyUrl":""
                        },
                        planetContext : {
                            "category": "Planets",
                            "type": "Planet",
                            "name": "Earth",
                            "coordinateSystem": {
                                "geoideName": "EPSG:4326"
                            },
                            "visible": true
                        }
                    });
            this.mizar = mizar;
            
            // Layers load
            for (var i = 0; i < context.layers.length; i++) {
                var layer = context.layers[i];

                mizar.addLayer(layer,function (id) {
                    var cbLayer = mizar.getLayerByID(id);
                    console.log(cbLayer);
                    if (cbLayer.type === Mizar.LAYER.WCSElevation) {
                        mizar.setBaseElevation(cbLayer.name);
                    }
                    if (cbLayer.name === "Palavas") {
                        this.palavasLayer = cbLayer;
                    }

                    if (cbLayer.isBackground() === true) {
                        setTimeout(function go() {
                            mizar.activatedContext.navigation.zoomTo([4.025,43.54],
                            //116.217,29.15
                            { "distance" : 45000,
                              "duration" : 100 });
                        },4000);
                    }
                });
            }
            
            
            var options = {
                "category": "SCO",
                "type": "GeoJSON",
                "pointMaxSize": 40,
                "visible": true,
                "opacity": 100,
                "pickable": true,
            };
            var thematics = [
                { "id" : "CLIMATE", "name" : "Climate", "color" : "#008777", "logo" : "images/thematics/CLIMATE.png" },
                { "id" : "WATER", "name" : "Water", "color" : "#0082C2", "logo" : "images/thematics/WATER.png" },
                { "id" : "OCEAN", "name" : "Ocean", "color" : "#004D7E", "logo" : "images/thematics/OCEAN.png" },
                { "id" : "AIR", "name" : "Air", "color" : "#8BB7E2", "logo" : "images/thematics/AIR.png" },
                { "id" : "LAND", "name" : "Land", "color" : "#94C11F", "logo" : "images/thematics/LAND.png" },
                { "id" : "HEALTH", "name" : "Health", "color" : "#009D45", "logo" : "images/thematics/HEALTH.png" },
                { "id" : "DISASTER", "name" : "Natural Disasters", "color" : "#E9483F", "logo" : "images/thematics/DISASTER.png" }
            ];
            var climateData = [
                    {
                        "thematicId": "WATER",
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "geometry": { "type": "Point", "coordinates": [116.217 , 29.15] },
                                "type": "Feature",
                                "properties": { "name": "Poyang lake", "title": "Poyang lake", "description": "Poyang lake" }
                            }
                        ]
                    },
                    {
                        "thematicId": "HEALTH",
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "geometry": { "type": "Point", "coordinates": [114.217 , 28.15] },
                                "type": "Feature",
                                "properties": { "name": "Poyang lake", "title": "Poyang lake", "description": "Poyang lake" }
                            }
                        ]
                    },
                    {
                        "thematicId": "LAND",
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "geometry": { "type": "Point", "coordinates": [112.217 , 30.15] },
                                "type": "Feature",
                                "properties": { "name": "Poyang lake", "title": "Poyang lake", "description": "Poyang lake" }
                            }
                        ]
                    },
                    {
                        "thematicId": "DISASTER",
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "geometry": { "type": "Point", "coordinates": [117.217 , 28.15] },
                                "type": "Feature",
                                "properties": { "name": "Poyang lake", "title": "Poyang lake", "description": "Poyang lake" }
                            }
                        ]
                    }
                    
                ];

            for (var i=0;i<climateData.length;i++) {
                var currentThematicId = climateData[i].thematicId;
                var currentThematic = null;
                for (var j=0;j<thematics.length;j++) {
                    if (thematics[j].id === currentThematicId) {
                        currentThematic = thematics[j];
                    }
                }
                options.name = currentThematic.name;
                options.color = currentThematic.color;

                var climateId = mizar.addLayer(options,function(id) {
                    var climateLayer = mizar.getLayerByID(id);
                    climateLayer.addFeatureCollection(climateData[i]);
                });
            }


            //console.log("SERVICE",mizar.getServiceByName(Mizar.SERVICE.PickingManager));
        });

    </script>

</head>


<body style="margin: 0; padding: 0;" onload="init();">
    <div>
        <input type="button" value="<" onclick="previous()"/>
        <input id="sl" type="text" value=""/>
        <input type="button" value=">" onclick="next()"/>
        
    </div>
    <div id="tracker">
        <div id="posTracker" style="position: relative; float:left;">ICI !</div>
    </div>
    <canvas id="MizarCanvas" style="border: none; margin: 0; padding: 0;"></canvas>

</body>
</html>